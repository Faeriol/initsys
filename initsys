#! /usr/bin/env python
"""initsys helps you init your remote system.
The base script does the very simple stuff.
"""

import os
import sys

def copyKey(server, githubUser):
    """Execute from local for bootstrap... for now"""
    key = "https://github.com/" +githubUser +".keys"
    command = "ssh " +server 
    command += " '[ -d ~/.ssh ] || mkdir ~/.ssh; wget -O ~/.ssh/authorized_keys -N " +key +"; chmod -R 0700 ~/.ssh'"
    os.system(command)

def dlAlias(server):
    myAliasFile = "https://raw.githubusercontent.com/Faeriol/initsys/master/bash_alias"
    os.system("ssh " +server +" wget -O .bash_alias -N " +myAliasFile)
    print "Downloaded fresh copy of bash_alias file, lets now set it in place"
    os.system("ssh " +server +" '[ -f ~/.bashrc ] && (grep -s -q \"source .bash_alias\" .bashrc || echo \"source .bash_alias\" >> ~/.bashrc)'")
    os.system("ssh " +server +" '[ -f ~/.profile ] && (grep -s -q \"source .bash_alias\" .profile || echo \"source .bash_alias\" >> ~/.profile)'")

def dlLocalAlias():
    myAliasFile = "https://raw.githubusercontent.com/Faeriol/initsys/master/bash_alias"
    os.system("wget -O .bash_alias -N " +myAliasFile)
    os.system("'[ -f ~/.bashrc ] && (grep -s -q \"source .bash_alias\" .bashrc || echo \"source .bash_alias\" >> ~/.bashrc)'")
    os.system("'[ -f ~/.profile ] && (grep -s -q \"source .bash_alias\" .profile || echo \"source .bash_alias\" >> ~/.profile)'")

def dlInitsys(server):
    myInitsys = "https://raw.githubusercontent.com/Faeriol/initsys/master/initsys"
    os.system("ssh " +server +" wget -O initsys -N " +myInitsys)

def dlVimrc(server):
    myVimrc = "https://raw.githubusercontent.com/Faeriol/initsys/master/vimrc"
    os.system("ssh " +server +" wget -O .vimrc -N " +myVimrc)
    print "Downloaded fresh copy of vimrc file, lets now set it in place"

def dlScreenrc(server):
    myScreenrc = "https://raw.githubusercontent.com/Faeriol/initsys/master/screenrc"
    os.system("ssh " +server +" wget -O .screenrc -N " +myScreenrc)
    print "Downloaded fresh copy of screenrc file."

def usage():
    print "initsys <machineToInit> <githubUser>"

if len(sys.argv) < 3 :
    usage()
elif sys.argv[1] == "remote":
    dlLocalAlias()
else :
    print "Let's enable Faeriol's config on this machine: " +sys.argv[1] +" with github user: " +sys.argv[2] 
    copyKey(sys.argv[1], sys.argv[2])
    dlInitsys(sys.argv[1])
    os.system("ssh " +sys.argv[1] +" remote")
    #dlAlias(sys.argv[1])
    #dlVimrc(sys.argv[1])
    #dlScreenrc(sys.argv[1])
    print "DONE"
